---
title: "UserGuide"
format: html
editor: visual
---

## *bulktrends User Guide*

*Examples of how to use the `bulktrends` package. First, let's load all of the functions contained within the package.*

```{r}
#| code-fold: true
#| warning: false

library(data.table)
library(ggplot2)
library(devtools)
devtools::load_all("../")
```

## *Load UK Trade Info Bulk Data Files*

*Load a single bulk data file or all of the files in a directory (and subdirectories).*

```{r}
if (file.exists("../data/imports.rds")) {
  imports <- readRDS("../data/imports.rds")
} else {
  imports <- read_uktradeinfo( path = "../data/imports/")
  saveRDS(imports, file = "../data/imports.rds")
}

head(imports)

```

## *Request Data from UK Trade Data API*

*Download look-up tables, e.g. for commodity codes and ports, and save, or load if already available.*

```{r}
lookup_tables <- c("Commodity","Port")
for ( i in lookup_tables ) {
  
  file <- paste0("../data/",i,".rds")
  
  if( file.exists(file) ){
    assign(i,readRDS(file))
  
    } else {
    assign(i, uktrades_request(endpoint = i)$value)
    saveRDS(get(i), file = file)  
    
    }
}

```

## *Quick Visualisation*

-   *Plot time series of a single commodity*

-   *Plot the time series of all commodities in "chapter"*

```{r}

comcode.plot <- function(import_data,
                         code,
                         lookuptable,
                         max_unique_comcodes=10) {
 
  #"code" info to meta
  lookuptable <- as.data.table(lookuptable)
  meta <- lookuptable[Cn8Code == code | Hs2Code == code |
                        Hs4Code == code | Hs6Code == code]
  
  #extract related codes once
  allcodes <- na.omit(unique(meta$Cn8Code))
  
  #filter main dataset for all matching codes and merge with meta
  import_data <- import_data[ COMCODE %in% allcodes ]
  
  #add month to import_data
  import_data[, month := as.POSIXct(paste0(PERREF,"01"),format="%Y%m%d")]

  #import_data[ , .(NET_MASS = sum(as.numeric(NET_MASS))), by = c("year","COMCODE") ]
  
  if ( import_data[,length(unique(COMCODE))] > max_unique_comcodes) {
    topX <- import_data[,.(NET_MASS=sum(as.numeric(NET_MASS))),by=COMCODE][
      order(NET_MASS,decreasing = T),COMCODE][1:max_unique_comcodes]
    import_data[ ! COMCODE %in% topX, COMCODE := "Other"]
    import_data <- import_data[,.(NET_MASS=sum(as.numeric(NET_MASS))),by=c("COMCODE","month")]
  }
  
  import_data <- merge(import_data, meta,
                       by.x = "COMCODE", by.y = "Cn8Code",
                       all.x=T)

  
  ## plot year and net mass
  ggplot(import_data, aes(x = month, y = as.numeric(NET_MASS), fill = factor(COMCODE))) +
  # geom_col() +
    geom_area() +
  scale_fill_manual(values = colorRampPalette(c("#c6dbef", "#6baed6", "#08306b"))(length(unique(import_data$COMCODE)))) +
  labs(title = "Total Weight by Commodity Code",
         subtitle = paste0(
           if (nchar(code) >= 2) {
             import_data[1,paste(Hs2Code, "-", stringr::str_wrap(Hs2Description, width = 90),"\n")]
           } else "",
           if (nchar(code) >= 4) {
             import_data[1,paste(Hs4Code, "-", stringr::str_wrap(Hs4Description, width = 90),"\n")]
           } else "",
           if (nchar(code) >= 6) {
             import_data[1,paste(Hs6Code, "-", stringr::str_wrap(Hs6Description, width = 90),"\n")]
           } else "",
           if (nchar(code) == 8) {
             import_data[1,paste(COMCODE, "-", stringr::str_wrap(Cn8LongDescription, width = 90),"\n")]
           } else ""),
         x = "Year",
         y = "Weight [kg/month]",
         fill = paste0("Commodity Code\n(Top ",max_unique_comcodes,")")) +
  guides(fill = guide_legend(keywidth = 0.8, keyheight = 0.6, ncol = 2)) + 
  theme_minimal(base_family = "serif") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(face = "bold", size = 12,
                                  color = "#7D2239", lineheight = 1.1),
        plot.subtitle = element_text(face = "bold", size = 11, color = "#003865"),
        legend.text = element_text(size = 9, family= "serif"),
        legend.title = element_text(face = "bold", size = 11, color = "#003865"))+
    scale_y_continuous(labels = scales::comma)
}

comcode.plot(imports, "06", lookuptable=Commodity,max_unique_comcodes = 10)
comcode.plot(imports, "0601", lookuptable=Commodity,max_unique_comcodes = 10)
comcode.plot(imports, "06011030", lookuptable=Commodity)


```

-   *Hierarchichal classification of a given commodity code*

```{r}
comcode.description <- function(code) {
  Commodity <- as.data.table(Commodity)
  meta <- Commodity[Cn8Code == code | Hs2Code == code | Hs4Code == code | Hs6Code == code]
  
  desc <- list(Hs2 = paste(meta$Hs2Code[1], " — ", meta$Hs2Description[1]),
               Hs4 = paste(meta$Hs4Code[1], " — ", meta$Hs4Description[1]),
               Hs6 = paste(meta$Hs6Code[1], " — ", meta$Hs6Description[1]),
               Cn8 = paste(meta$Cn8Code[1], " — ", meta$Cn8LongDescription[1]))
  
  # structured format
  cat("\nHierarchical Description for Code:", code, "\n")
  cat("---------------------------------------------\n")
  cat("Chapter (Hs2):          ", desc$Hs2, "\n")
  cat("Heading (Hs4):          ", desc$Hs4, "\n")
  cat("Subheading (Hs6):       ", desc$Hs6, "\n")
  cat("Commodity code (Cn8):   ", desc$Cn8, "\n")
  cat("---------------------------------------------\n\n")
}

#comcode.description("08")
#comcode.description("0803")
comcode.description("08039010")
```
