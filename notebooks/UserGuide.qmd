---
title: "User Guide: `bulktrends`"
format: html
editor: visual
---

```{r install-package}
#| include: false
devtools::install("../", upgrade = FALSE)
```

Examples of how to use the `bulktrends` package (version `r packageVersion("bulktrends")`). First, let's load the package and add the path to where we are storing data.

```{r set-up}
#| warning: false
#| message: false
library(bulktrends)
data_directory <- "../data/"
```

## Load UK Trade Info Bulk Data Files

Load a single bulk data file or all of the files in a directory (and subdirectories). This can take a while for multiple years of data, so it is recommended to save the loaded data as an `.RDS` for quicker loading in the future.

```{r load-trade-data}
#| include: false
if ( !exists("imports") ){
  if (file.exists(paste0(data_directory,"imports.rds"))) {
    imports <- readRDS(paste0(data_directory,"imports.rds"))
  } else {
    imports <- read_uktradeinfo( path = paste0(data_directory,"imports/"))
    saveRDS(imports, file = paste0(data_directory,"imports.rds"))
  }
}
```

```{r}
#| eval: false
imports <- read_uktradeinfo( path = paste0(data_directory,"imports/"))
saveRDS(imports, file = paste0(data_directory,"imports.rds"))
# imports <- readRDS(paste0(data_directory,"imports.rds"))
```

```{r}
head(imports)
```

### Things to be aware of

-   Country of origin reporting changes from 2022 onward, individual EU countries are specified where previously they were not. There is therefore a large increase in volume (number or rows) of import data
-   "Low value Trade EU", port code QVV only report chapter of COMCODE and do not include NET_WEIGHT

## Request Data from UK Trade Data API

Download look-up tables, e.g. for commodity codes and ports, and save, or load if already available.

```{r load-lookup-tables}
#| include: false
lookup_tables <- c("Commodity","Port")
for ( i in lookup_tables ) {
  
  file <- paste0(data_directory,i,".rds")
  
  if( file.exists(file) ){
    assign(i,readRDS(file))
    
  } else {
    assign(i, uktrades_request(endpoint = i)$value)
    saveRDS(get(i), file = file)  
    
  }
}
```

```{r}
#| eval: false
Commodity <- uktrades_request(endpoint = "Commodity")$value
```

```{r}
head(Commodity)
```

## Quick Visualisation

The `comcode_plot()` function produces time plots of imports by various measures included in import data, including mass, value (Â£) and volume (number of imports).

Here are some examples:

```{r plot-examples}
comcode_plot(imports, "01", comcode_lookup=Commodity)

comcode_plot(imports, "0602", variable="STAT_VALUE", comcode_lookup=Commodity)

comcode_plot(imports, "01", variable="volume",comcode_lookup = Commodity)


```

-   Hierarchical classification of a given commodity code

```{r comcode-descriptions}

comcode_description("01012990", Commodity)
comcode_description("08039010", Commodity)
```

## Anomaly detection

For a given commodity and quantity, a series of helper functions extract an aggregated time series by summing all commodities with the specified code by time period, and a regression model is automatically selected from a pool of candidates. Finally, an outlier detection algorithm is run to detect outliers of various types ("AO" additive outliers, "LS" level shifts, "TC" temporary changes, "IO" innovative outliers and "SLS" seasonal level shifts).

```{r}
#| warning: false

ts_data <- extract_ts(imports, "01", quantity="NET_MASS")

selected_model <- select_best_model(ts_data)

detect_anomaly <- tso(y = scale(ts_data),
                      cval=5,
                      types = c("AO", "LS", "TC", "IO"),
                      xreg = selected_model$xreg)

print(detect_anomaly)
plot.tsoutliers(detect_anomaly)

```

This procedure is performed for a list of commodity codes...

```{r}
#| warning: false
hs2_codes <- unique(substr(imports$COMCODE, 1,2))

hs2_anomalies <- detect_anomalies(import_data = imports,
                                  codes = hs2_codes[1:3])

print(hs2_anomalies)
```
