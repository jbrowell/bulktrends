---
title: "UserGuide"
format: html
editor: visual
---

## bulktrends User Guide

Examples of how to use the `bulktrends` package. First, let's load all of the functions contained within the package.

```{r set-up}
#| code-fold: true
#| warning: false

library(data.table)
library(ggplot2)
library(forecast)
library(tsoutliers)
library(devtools)
devtools::load_all("../")
```

## Load UK Trade Info Bulk Data Files

Load a single bulk data file or all of the files in a directory (and subdirectories).

```{r load-trade-data}
if ( !exists("imports") ){
  if (file.exists("../data/imports.rds")) {
    imports <- readRDS("../data/imports.rds")
  } else {
    imports <- read_uktradeinfo( path = "../data/imports/")
    saveRDS(imports, file = "../data/imports.rds")
  }
}
head(imports)

```

### Things to be aware of

-   Country of origin reporting changes from 2022 onward, individual EU countries are specified where previously they were not. There is therefore a large increase in volume (number or rows) of import data
-   "Low value Trade EU", port code QVV only report chapter of COMCODE and do not include NET_WEIGHT

## Request Data from UK Trade Data API

Download look-up tables, e.g. for commodity codes and ports, and save, or load if already available.

```{r load-lookup-tables}
lookup_tables <- c("Commodity","Port")
for ( i in lookup_tables ) {
  
  file <- paste0("../data/",i,".rds")
  
  if( file.exists(file) ){
    assign(i,readRDS(file))
  
    } else {
    assign(i, uktrades_request(endpoint = i)$value)
    saveRDS(get(i), file = file)  
    
    }
}

```

## Quick Visualisation

The `comcode_plot()` function produces time plots of imports by various measures included in import data, including mass, value (Â£) and volume (number of imports).

Here are some examples:

```{r plot-examples}
comcode_plot(imports, "01", comcode_lookup=Commodity)

comcode_plot(imports, "0602", variable="STAT_VALUE", comcode_lookup=Commodity)

comcode_plot(imports, "01", variable="volume",comcode_lookup = Commodity)


```

-   Hierarchichal classification of a given commodity code

```{r comcode-descriptions}

comcode_description("01012990", Commodity)
comcode_description("08039010", Commodity)
```

-   Anomaly detection in time series of a given commodity

```{r}

#Example of anomaly detection for an individual code (loop for all codes can be found in script)

ts_data <- extract_netmass_ts(imports, "19")

selected_model <- select_best_model(ts_data, metric="aic")

detect_anomaly <- tso(y = ts_data,
                      cval=5,
                      types = c("AO", "LS", "TC", "IO"),
                      tsmethod = "auto.arima",
                      xreg = selected_model$xreg)

print(detect_anomaly)

plot.tsoutliers(detect_anomaly)
```
